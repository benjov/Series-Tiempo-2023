%   Funcion de Maxima Verosimilitud del modelo M-GARCH-M multivariado
%   basado en Bollerslev (1990) CCC y VEC DIagonal
%   Elaborado por Benjamin Oliva Vazquez
%   Ultima actualizacion: 3 de Mayo de 2010
%   De momento pensaremos en solo 1 rezago
%   Argumentos: Y = matriz con las variables dependientes; Yt_1 = matriz de
%   variables independientes en t-1; Yt_2 = matriz de variables
%   independientes en t-1; Zt = variables exogenas.

function [llkGARCHM] = llk_M_Garch_M_V1(B,Yt,Yt_1,Yt_2,Yt_3,Zt)
[T,N] = size(Yt);
one = ones(T,N);
    resid = (Yt)'-(one*sparse(1:N,1:N,[B(1); B(2); B(3)]))'...
            -(([B(4), B(5), B(6); B(13), B(14), B(15);...
            B(22), B(23), B(24)])*(Yt_1)')...
            -(([B(7), B(8), B(9); B(16), B(17), B(18);...
            B(25), B(26), B(27)])*(Yt_2)')...
            -(([B(10), B(11), B(12); B(19), B(20), B(21);...
            B(28), B(29), B(30)])*(Yt_3)')...
            -([B(55), B(58); B(56), B(59); B(57), B(60)])*(Zt(1:T,:))';
    Ht = cov(resid');
    Ut1 = Yt(1,1) - B(1) - ([B(4), B(5), B(6)])*Yt_1(1,:)'...
          - ([B(7), B(8), B(9)])*Yt_2(1,:)'...
          - ([B(10), B(11), B(12)])*Yt_3(1,:)'...
          - ([B(31), B(32), B(33)])*(diag(Ht).^.5) - B(55)*Zt(1,1)...
          - B(58)*Zt(1,2);
    Ut2 = Yt(1,2) - B(2) - ([B(13), B(14), B(15)])*Yt_1(1,:)'...
          - ([B(16), B(17), B(18)])*Yt_2(1,:)'...
          - ([B(19), B(20), B(21)])*Yt_3(1,:)'...
          - ([B(34), B(35), B(36)])*(diag(Ht).^.5) - B(56)*Zt(1,1)...
          - B(59)*Zt(1,2);
    Ut3 = Yt(1,3) - B(3) - ([B(22), B(23), B(24)])*Yt_1(1,:)'...
          - ([B(25), B(26), B(27)])*Yt_2(1,:)'...
          - ([B(28), B(29), B(30)])*Yt_3(1,:)'...
          - ([B(37), B(38), B(39)])*(diag(Ht).^.5) - B(57)*Zt(1,1)...
          - B(60)*Zt(1,2);
LLK = 0;
for t = 2:T
    S2t1 = B(40) + B(43)*Ut1^2 + B(46)*Ht(1,1) + B(49)*Yt(t-1,1);
    S2t2 = B(41) + B(44)*Ut2^2 + B(47)*Ht(2,2) + B(50)*Yt(t-1,2);
    S2t3 = B(42) + B(45)*Ut3^2 + B(48)*Ht(3,3) + B(51)*Yt(t-1,3);
    S2t12 = B(52)*sqrt(S2t1*S2t2);
    S2t13 = B(53)*sqrt(S2t1*S2t3);
    S2t23 = B(54)*sqrt(S2t2*S2t3);
%     Ht = [S2t1, S2t12, S2t13;...
%           S2t12, S2t2, S2t23;...
%           S2t13, S2t23, S2t3];
    Ut1 = Yt(t,1) - B(1) - ([B(4), B(5), B(6)])*Yt_1(t,:)'...
          - ([B(7), B(8), B(9)])*Yt_2(t,:)'...
          - ([B(10), B(11), B(12)])*Yt_3(t,:)'...
          - ([B(31), B(32), B(33)])*(diag(Ht).^.5) - B(55)*Zt(t,1)...
          - B(58)*Zt(t,2);
    Ut2 = Yt(t,2) - B(2) - ([B(13), B(14), B(15)])*Yt_1(t,:)'...
          - ([B(16), B(17), B(18)])*Yt_2(t,:)'...
          - ([B(19), B(20), B(21)])*Yt_3(t,:)'...
          - ([B(34), B(35), B(36)])*(diag(Ht).^.5) - B(56)*Zt(t,1)...
          - B(59)*Zt(t,2);
    Ut3 = Yt(t,3) - B(3) - ([B(22), B(23), B(24)])*Yt_1(t,:)'...
          - ([B(25), B(26), B(27)])*Yt_2(t,:)'...
          - ([B(28), B(29), B(30)])*Yt_3(t,:)'...
          - ([B(37), B(38), B(39)])*(diag(Ht).^.5) - B(57)*Zt(t,1)...
          - B(60)*Zt(t,2);
    Ut = [Ut1; Ut2; Ut3];
    Ht = [S2t1, S2t12, S2t13;...
          S2t12, S2t2, S2t23;...
          S2t13, S2t23, S2t3];
    
    llkt = - (N/2)*log(2*pi) - (1/2)*log(max(1e-30,det(Ht)))...
           - (1/2)*(Ut'*inv(Ht)*Ut);
    llkt = -llkt;
    LLK = LLK + llkt;
end
llkGARCHM = LLK;